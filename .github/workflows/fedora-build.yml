name: Build CTP2 for Fedora

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. System vorbereiten
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which findutils

    # 2. Code auschecken
    - name: Checkout Code
      uses: actions/checkout@v4

    # 3. Konfiguration und Patches
    - name: Configure and Fix
      run: |
        # Autotools ausführen (erzeugt die Basis-Skripte)
        ./autogen.sh

        # FIX 1: Veraltete FreeType-Konfigurationsdateien ersetzen
        echo "Patching FreeType configuration files..."
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/
        
        # Ausführrechte sicherstellen
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # FIX 2: MD5-Namenskollisionen beheben (Umbenennung zu CTP_MD5...)
        echo "Renaming MD5 functions in anet..."
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Init/CTP_MD5Init/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Update/CTP_MD5Update/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Final/CTP_MD5Final/g' {} +

        # FIX 3: PROTO_LIST Makro in global.h korrigieren
        # Wir ändern die Definition so, dass Argumente durchgereicht werden (Standard C),
        # anstatt sie zu löschen (altes K&R C Verhalten).
        echo "Patching global.h for Standard C..."
        sed -i 's/#define PROTO_LIST(list) ()/#define PROTO_LIST(list) list/g' ctp2_code/libs/anet/src/3rdparty/md5/global.h

        # Compiler-Flags setzen
        # -fpermissive: Erlaubt alten C++ Code
        # -w: Unterdrückt Warnungen
        # -DPROTOTYPES=1: Hilft bei alten Headern, korrekte Prototypen zu nutzen
        export CFLAGS="-fpermissive -w -DPROTOTYPES=1"
        export CXXFLAGS="-fpermissive -w -DPROTOTYPES=1"
        
        # Konfiguration starten
        ./configure --prefix=/usr --enable-silent-rules

    # 4. Kompilieren
    - name: Compile
      run: |
        make -j$(nproc)

    # 5. Artefakte verpacken (Korrigierter Pfad!)
    - name: Prepare Artifact
      run: |
        mkdir -p dist
        
        # Wir suchen die Datei 'ctp2' (executable), egal wo sie liegt
        # Meistens in ctp2_code/ oder .libs/
        EXE_PATH=$(find . -name "ctp2" -type f -executable | head -n 1)
        
        if [ -z "$EXE_PATH" ]; then
            echo "FEHLER: Datei 'ctp2' wurde nicht gefunden!"
            # Debugging: Zeige alle Dateien an, um zu sehen wo sie steckt
            find . -name "ctp2*"
            exit 1
        else
            echo "Gefunden: $EXE_PATH"
            cp "$EXE_PATH" dist/
        fi
        
        # Daten
        if [ -d "ctp2_data" ]; then cp -r ctp2_data dist/; fi
        
        # Libraries (optional)
        mkdir -p dist/libs
        find . -name "*.so" -exec cp {} dist/libs/ \; || true

    # 6. Upload
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora
        path: dist/
        compression-level: 6
