name: Build CTP2 for Fedora

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. System aktualisieren und Tools installieren
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which findutils

    # 2. Quellcode auschecken
    - name: Checkout Code
      uses: actions/checkout@v4

   # 3. Konfiguration und Patches
    - name: Configure and Fix
      run: |
        ./autogen.sh

        # FreeType Fix
        echo "Patching FreeType..."
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # MD5 Rename Fix (CTP_MD5...)
        echo "Renaming MD5 functions..."
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Init/CTP_MD5Init/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Update/CTP_MD5Update/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Final/CTP_MD5Final/g' {} +

        # PROTO_LIST Fix (Der entscheidende neue Teil!)
        # Wir entfernen das PROTO_LIST Makro in md5.h komplett, damit der Compiler Standard-C sieht.
        echo "Fixing PROTO_LIST in md5.h..."
        sed -i 's/PROTO_LIST ((MD5_CTX \*))/(MD5_CTX *)/g' ctp2_code/libs/anet/src/3rdparty/md5/md5.h
        sed -i 's/PROTO_LIST ((unsigned char \*, unsigned int))/(unsigned char *, unsigned int)/g' ctp2_code/libs/anet/src/3rdparty/md5/md5.h
        sed -i 's/PROTO_LIST ((unsigned char \[16\], MD5_CTX \*))/(unsigned char [16], MD5_CTX *)/g' ctp2_code/libs/anet/src/3rdparty/md5/md5.h

        # Zus√§tzlich globale Flags
        export CFLAGS="-fpermissive -w -D__STDC__=1"
        export CXXFLAGS="-fpermissive -w -D__STDC__=1"
        
        ./configure --prefix=/usr --enable-silent-rules

    # 4. Kompilieren (nutzt alle CPU-Kerne)
    - name: Compile
      run: |
        make -j$(nproc)

    # 5. Artefakte sammeln
    - name: Prepare Artifact
      run: |
        mkdir -p dist
        
        # Das Spiel selbst
        cp ctp2 dist/
        
        # Spieldaten (falls im Repo vorhanden)
        if [ -d "ctp2_data" ]; then cp -r ctp2_data dist/; fi
        
        # Optional: Mapgen Libraries sichern
        mkdir -p dist/libs
        find . -name "*.so" -exec cp {} dist/libs/ \; || true

    # 6. Als ZIP hochladen
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora
        path: dist/
        compression-level: 6
