name: Build CTP2 for Fedora

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. System aktualisieren und Dependencies installieren
    # Wir versuchen 'binutils-gold' zu installieren, aber ignorieren Fehler falls das Paket anders heißt.
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which findutils binutils
        
        # Versuch, den Gold-Linker zu installieren (optional)
        dnf -y install binutils-gold || echo "binutils-gold package not found, continuing..."

    # 2. Quellcode holen
    - name: Checkout Code
      uses: actions/checkout@v4

    # 3. Konfiguration und Patches
    - name: Configure and Fix
      run: |
        ./autogen.sh

        # FIX: FreeType Configs patchen
        echo "Patching FreeType..."
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # FIX: MD5 Namenskollisionen
        echo "Renaming MD5 functions..."
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Init/CTP_MD5Init/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Update/CTP_MD5Update/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Final/CTP_MD5Final/g' {} +
        
        # FIX: PROTO_LIST Makro in global.h
        echo "Patching global.h..."
        sed -i 's/#define PROTO_LIST(list) ()/#define PROTO_LIST(list) list/g' ctp2_code/libs/anet/src/3rdparty/md5/global.h

        # LINKER CHECK: Prüfen, ob ld.gold wirklich da ist
        if command -v ld.gold >/dev/null 2>&1; then
            echo "Gold linker found. Using -fuse-ld=gold"
            LINKER_FLAG="-fuse-ld=gold"
        else
            echo "Gold linker NOT found. Using default linker (ld)."
            LINKER_FLAG=""
        fi

        # FLAGS setzen
        # -O3: Optimierung (laut Anleitung)
        # -fpermissive: Pflicht für alten Code
        # -DPROTOTYPES=1: Pflicht für anet Lib
        export CFLAGS="-O3 $LINKER_FLAG -fpermissive -w -DPROTOTYPES=1"
        export CXXFLAGS="-O3 $LINKER_FLAG -fpermissive -w -DPROTOTYPES=1"
        
        ./configure --prefix=/usr --enable-silent-rules
   # 4. Kompilieren (mit Retry für Race-Conditions)
    - name: Compile
      run: |
        echo "Starting parallel build..."
        # Wir probieren es erst schnell (parallel)
        if ! make -j$(nproc); then
            echo "Parallel build failed (Race Condition known issue). Retrying single-threaded..."
            # Wenn das fehlschlägt, machen wir es langsam und sicher (Single Core)
            make -j1
        fi

    # 5. Artefakte vorbereiten (Struktur wie Spiel erwartet)
    - name: Prepare Artifact
      run: |
        # Struktur für das Spiel anlegen
        mkdir -p dist/ctp2_code/ctp/dll/map
        
        # Executable suchen und kopieren
        EXE_PATH=$(find . -name "ctp2" -type f -executable | head -n 1)
        if [ -z "$EXE_PATH" ]; then echo "Error: ctp2 executable not found!"; exit 1; fi
        cp "$EXE_PATH" dist/ctp2_code/ctp/
        
        # Mapgen Libraries suchen und kopieren
        # Wir suchen erst im mapgen-Ordner, dann global zur Sicherheit
        echo "Copying Mapgen Libraries..."
        find ctp2_code/mapgen -name "*.so" -exec cp -v {} dist/ctp2_code/ctp/dll/map/ \;
        
        # Prüfen ob Libs da sind, sonst global suchen (Fallback)
        COUNT=$(ls dist/ctp2_code/ctp/dll/map/*.so 2>/dev/null | wc -l)
        if [ "$COUNT" -eq "0" ]; then
             echo "Warning: No libs in mapgen found, searching globally..."
             find . -name "*.so" -exec cp -v {} dist/ctp2_code/ctp/dll/map/ \;
        fi

        # Spieldaten (falls im Repo)
        if [ -d "ctp2_data" ]; then cp -r ctp2_data dist/; fi

    # 6. Upload
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora
        path: dist/
        compression-level: 6
