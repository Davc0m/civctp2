name: Build CTP2 for Fedora (Official Way)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. Dependencies (plus 'findutils' und 'binutils' für den gold-linker)
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which findutils binutils

    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Config & Patching (MD5 Fix + FreeType Fix bleiben nötig!)
    - name: Configure and Fix
      run: |
        ./autogen.sh

        # Patch FreeType (nötig für Fedora Build)
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # Patch MD5 in anet (Namenskonflikte)
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Init/CTP_MD5Init/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Update/CTP_MD5Update/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Final/CTP_MD5Final/g' {} +
        
        # Patch Global.h (PROTO_LIST)
        sed -i 's/#define PROTO_LIST(list) ()/#define PROTO_LIST(list) list/g' ctp2_code/libs/anet/src/3rdparty/md5/global.h

        # FLAGS aus der offiziellen Anleitung!
        # Wir nutzen -O3 und -fuse-ld=gold (gold linker)
        export CFLAGS="-O3 -fuse-ld=gold -fpermissive -w -DPROTOTYPES=1"
        export CXXFLAGS="-O3 -fuse-ld=gold -fpermissive -w -DPROTOTYPES=1"
        
        ./configure --prefix=/usr --enable-silent-rules

    # 3. Compile
    - name: Compile
      run: |
        make -j$(nproc)

    # 4. Packaging (Struktur genau wie in der Anleitung)
    - name: Prepare Artifact
      run: |
        mkdir -p dist/ctp2_code/ctp
        
        # Executable suchen und an den Ort kopieren, wo es erwartet wird
        # Die Anleitung sagt: ctp2_code/ctp/ctp2
        EXE_PATH=$(find . -name "ctp2" -type f -executable | head -n 1)
        cp "$EXE_PATH" dist/ctp2_code/ctp/
        
        # Libraries kopieren (Manueller Schritt aus der Anleitung!)
        # Ziel: ctp2_code/ctp/dll/map/
        mkdir -p dist/ctp2_code/ctp/dll/map
        
        echo "Suche und kopiere Mapgen Libraries..."
        # Wir suchen die .so Dateien im Build-Ordner
        find ctp2_code/mapgen -name "*.so" -exec cp -v {} dist/ctp2_code/ctp/dll/map/ \;
        
        # Falls sie nicht da sind (manchmal in .libs versteckt), suchen wir globaler
        COUNT=$(ls dist/ctp2_code/ctp/dll/map/*.so 2>/dev/null | wc -l)
        if [ "$COUNT" -eq "0" ]; then
            echo "Warnung: Keine Libs in mapgen gefunden, suche global..."
            find . -name "*.so" -exec cp -v {} dist/ctp2_code/ctp/dll/map/ \;
        fi

        # Spieldaten (falls vorhanden)
        if [ -d "ctp2_data" ]; then 
            cp -r ctp2_data dist/
        fi

    # 5. Upload
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora-Gold
        path: dist/
        compression-level: 6
