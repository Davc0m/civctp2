name: Build CTP2 for Fedora

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. System aktualisieren und Tools installieren
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which findutils

    # 2. Quellcode auschecken
    - name: Checkout Code
      uses: actions/checkout@v4

    # 3. Konfiguration und Patches
    - name: Configure and Fix
      run: |
        # Autotools ausführen (erzeugt frische config.guess/sub/missing Skripte)
        ./autogen.sh

        # FIX 1: Veraltete FreeType-Konfigurationsdateien ersetzen
        echo "Patching FreeType configuration files..."
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/
        
        # Ausführrechte sicherstellen
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # FIX 2: MD5-Namenskollisionen im Netzwerk-Code beheben
        # Wir benennen alle MD5-Funktionen um (MD5Init -> CTP_MD5Init)
        echo "Renaming MD5 functions in anet..."
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Init/CTP_MD5Init/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Update/CTP_MD5Update/g' {} +
        find ctp2_code/libs/anet -name "*.[ch]" -exec sed -i 's/MD5Final/CTP_MD5Final/g' {} +

        # FIX 3: PROTO_LIST Makro entfernen (Verursacht Argument-Fehler)
        # Wir entfernen das "PROTO_LIST" Makro und behalten nur die Argumente in den Klammern.
        echo "Fixing PROTO_LIST macros in md5.h..."
        sed -i -E 's/PROTO_LIST[[:space:]]*\((.*)\)/\1/g' ctp2_code/libs/anet/src/3rdparty/md5/md5.h
        # Falls dabei doppelte Klammern ((...)) entstehen, reduzieren wir sie auf einfache (...)
        sed -i -E 's/\(\((.*)\)\)/(\1)/g' ctp2_code/libs/anet/src/3rdparty/md5/md5.h

        # Compiler-Flags setzen
        # -fpermissive: Erlaubt alten C++ Code
        # -w: Unterdrückt Warnungen
        # -D__STDC__=1: Hilft bei alten C-Headern
        export CFLAGS="-fpermissive -w -D__STDC__=1"
        export CXXFLAGS="-fpermissive -w -D__STDC__=1"
        
        # Konfiguration starten
        ./configure --prefix=/usr --enable-silent-rules

    # 4. Kompilieren (nutzt alle CPU-Kerne)
    - name: Compile
      run: |
        make -j$(nproc)

    # 5. Artefakte sammeln
    - name: Prepare Artifact
      run: |
        mkdir -p dist
        
        # Das Spiel selbst
        cp ctp2 dist/
        
        # Spieldaten (falls im Repo vorhanden)
        if [ -d "ctp2_data" ]; then cp -r ctp2_data dist/; fi
        
        # Optional: Mapgen Libraries sichern
        mkdir -p dist/libs
        find . -name "*.so" -exec cp {} dist/libs/ \; || true

    # 6. Als ZIP hochladen
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora
        path: dist/
        compression-level: 6
