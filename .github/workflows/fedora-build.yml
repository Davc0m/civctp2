name: Build CTP2 for Fedora

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    # 1. System vorbereiten
    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install git gcc-c++ make cmake automake autoconf libtool \
        SDL2-devel SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel \
        byacc flex tar yasm unzip which

    # 2. Code laden
    - name: Checkout Code
      uses: actions/checkout@v4

    # 3. Konfiguration und Fixes f端r alte Bibliotheken
    - name: Configure and Fix
      run: |
        # Autotools initialisieren (erzeugt aktuelle config.guess/sub/missing)
        ./autogen.sh

        # FIX: Die uralten Skripte in der FreeType-Lib durch neue ersetzen
        echo "Patching FreeType configuration files..."
        cp ctp2_code/os/autoconf/config/config.guess ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/config.sub   ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/missing      ctp2_code/libs/freetype-1.3.1/
        cp ctp2_code/os/autoconf/config/install-sh   ctp2_code/libs/freetype-1.3.1/

        # Ausf端hrbar machen sicherstellen
        chmod +x ctp2_code/libs/freetype-1.3.1/configure
        chmod +x ctp2_code/libs/freetype-1.3.1/missing

        # Configure starten
        # -fpermissive: Ignoriert veraltete C++ Syntax-Fehler
        # -w: Unterdr端ckt Warnungen, damit das Log lesbar bleibt
        export CFLAGS="-fpermissive -w"
        export CXXFLAGS="-fpermissive -w"
        
        ./configure --prefix=/usr --enable-silent-rules

    # 4. Kompilieren
    - name: Compile
      run: |
        make -j$(nproc)

    # 5. Paket schn端ren
    - name: Prepare Artifact
      run: |
        mkdir -p dist
        
        # Das kompilierte Spiel
        cp ctp2 dist/
        
        # Die Daten-Dateien (falls vorhanden)
        if [ -d "ctp2_data" ]; then cp -r ctp2_data dist/; fi
        
        # Mapgen Bibliotheken (falls shared libs gebaut wurden)
        mkdir -p dist/libs
        find . -name "*.so" -exec cp {} dist/libs/ \; || true

    # 6. Hochladen
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CTP2-Apolyton-Fedora
        path: dist/
        compression-level: 6
